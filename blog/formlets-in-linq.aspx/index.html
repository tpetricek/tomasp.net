<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
  <meta name=viewport content="width=device-width, initial-scale=1">
  <link rel="alternate" type="application/rss+xml" title="Latest news from Tomas Petricek" href="/rss.xml" />
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet"
    integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" 
    integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">  
    
  <link href="/custom/style.css" rel="stylesheet">
  <link href="/custom/tooltips.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="180x180" href="/img/favicon-big.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/img/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/img/favicon-big.png">
  <meta name="msapplication-TileColor" content="#00202D">
  <meta name="msapplication-TileImage" content="/img/favicon-big.png">
  <meta name="theme-color" content="#00202D">  
  
  
  <title>Beyond the Monad fashion (II.): Creating web forms with LINQ - Tomas Petricek</title>

  <meta name="description" content=" Formlets are elegant functional abstraction for describing web forms encapsulating both rendering and functionality. In this article, we look how to write formlets in C#. Although formlets are not monads, we can still use elegant LINQ syntax. Interestingly, using the join clause..." />
  <meta name="keywords" content="c#, research, " />  
  <meta name="author" content="Tomas Petricek" />
  <meta name="copyright" content="Tomas Petricek" />
  
  <meta property="og:title" content="Beyond the Monad fashion (II.): Creating web forms with LINQ" />
  <meta property="og:type" content="article" />
  <meta property="og:url" content="http://tomasp.net/blog/formlets-in-linq.aspx/" />
  <meta property="og:image" content="" />
  <meta property="og:description" content=" Formlets are elegant functional abstraction for describing web forms encapsulating both rendering and functionality. In this article, we look how to write formlets in C#. Although formlets are not monads, we can still use elegant LINQ syntax. Interestingly, using the join clause..." />
  
  <meta name="twitter:card" content="summary">
  
  <meta name="twitter:site" content="@tomaspetricek">
  <meta name="twitter:creator" content="@tomaspetricek">  
  <meta name="twitter:title" content="Beyond the Monad fashion (II.): Creating web forms with LINQ" />
  <meta name="twitter:image" content="" />
  <meta name="twitter:description" content=" Formlets are elegant functional abstraction for describing web forms encapsulating both rendering and functionality. In this article, we look how to write formlets in C#. Although formlets are not monads, we can still use elegant LINQ syntax. Interestingly, using the join clause..." />
    
  <script type="application/ld+json">
  {
  	"@context": "http:\/\/schema.org",
  	"@type": "Article",
  	"name": "Beyond the Monad fashion (II.): Creating web forms with LINQ",
    "headline": "Beyond the Monad fashion (II.): Creating web forms with LINQ",
  	"description": " Formlets are elegant functional abstraction for describing web forms encapsulating both rendering and functionality. In this article, we look how to write formlets in C#. Although formlets are not monads, we can still use elegant LINQ syntax. Interestingly, using the join clause...",
  	"url": "http://tomasp.net/blog/formlets-in-linq.aspx/",
  	"author": {
  		"@type": "Person",
  		"name": "Tomas Petricek",
  		"url": "http://tomasp.net",
  		"sameAs": ["http://twitter.com/tomaspetricek"]
  	},
  	"creator": ["Tomas Petricek"],
  	"dateCreated": "2011-03-14T17:14:49.0000000",
  	"datePublished": "2011-03-14T17:14:49.0000000",
    "dateModified": "2011-03-14T17:14:49.0000000",
    "mainEntityOfPage": "http://tomasp.net/blog/formlets-in-linq.aspx/",
  	"image": "",
  	"thumbnailUrl": "",
  	"keywords": ["c#", "research",  "tomas", "petricek"],
  	"inLanguage": "en-us",
  	"publisher": {
  		"@type": "Person",
  		"name": "Tomas Petricek",
  		"url": "http://tomasp.net",
      "logo": "http://tomasp.net/img/favicon-big.png",
  		"sameAs": ["http://twitter.com/tomaspetricek"]
  	}
  }  
  </script>
  
</head>
<body class="default">  
  <div class="not-footer">
  <div class="top-panel-wrapper">
  <div class="top-panel">
  <div id="tomas" class="visible-" itemscope itemtype="http://schema.org/Person"><header>
    <div class="container">
      <div class="col-md-8">
        
        <div class="row">
          <div class="col-xs-12 col-sm-8 col-md-12" style="padding:0px">
            <h2 itemprop="name">Tomas Petricek</h1>
            <h3 itemprop="description">Searching for new ways of thinking in programming &amp; working with data</h2>
            <div> 
              <img src="/img/tomas-sl-sq.jpg" class="hidden-lg hidden-md hidden-sm tomas-float" />
                <p>I believe that the most interesting work is not the one solving hard problems, but the one changing how
                  we think about the world. I follow this belief in my work on data science tools,
                  functional programming and F# teaching, in my programming languages research
                  and I try to understand it through philosophy of science.
                </p>
            </div>
          </div>
          <div class="hidden-lg hidden-md col-sm-4 hidden-xs">
            <img src="/img/tomas-sl-sq.jpg" class="tomas-square" />
            <p class="social">
              <a title="Follow my occasional rants" itemprop="sameAs" href="http://twitter.com/tomaspetricek"><i class="fa fa-twitter"></i></a>
              <a title="Send me a message" itemprop="sameAs" href="mailto:tomas@tomasp.net"><i class="fa fa-envelope"></i></a>
              <a title="Most of my open-soruce projects" itemprop="sameAs" href="http://github.com/tpetricek"><i class="fa fa-github-alt"></i></a>
              <a title="My F# answers on StackOverflow" itemprop="sameAs" href="http://stackoverflow.com/users/33518/tomas-petricek"><i class="fa fa-stack-overflow"></i></a>
              <a title="Read my papers!" itemprop="sameAs" href="http://dblp.uni-trier.de/pers/hd/p/Petricek:Tomas"><i class="fa fa-university"></i></a>
              <a title="Send me recruiter spam?" itemprop="sameAs" href="https://www.linkedin.com/in/tomaspetricek"><i class="fa fa-linkedin-square"></i></a>
            </p>
          </div>
        </div>
          
        <div class="row themes">
          <div class="col-sm-4">
            <h4><a href="http://thegamma.net"><i class="fa fa-area-chart"></i> The Gamma</a></h3>
            <p>I'm working on making data-driven storytelling easier, more open and reproducible
              at the <a href="https://turing.ac.uk/">Alan Turing Institute</a>.</p>              
          </div>
          <div class="col-sm-4">
            <h4><a href="http://fsharpworks.com"><i class="fa fa-industry"></i> Consulting</a></h3>
            <p>I'm author of definitive F# books and open-soruce libraries.
              I offer my F# training and consulting services as part of 
              <a href="http://fsharpworks.com">fsharpWorks</a>.</p>
          </div>
          <div class="col-sm-4">
            <h4><a href="/academic"><i class="fa fa-university"></i> Academic</a></h3>
            <p>I published papers about theory of context-aware programming langauges, 
              type providers, but also philosophy of science.</p>
          </div>
        </div>
          
      </div>
      
      <div class="col-sm-4">
        <img itemprop="image" src="/img/tomas-sl-wide.jpg" class="hidden-sm hidden-xs tomas-wide" />
        <p class="social hidden-sm">
          <a title="Follow my occasional rants" itemprop="sameAs" href="http://twitter.com/tomaspetricek"><i class="fa fa-twitter"></i></a>
          <a title="Send me a message" itemprop="sameAs" href="mailto:tomas@tomasp.net"><i class="fa fa-envelope"></i></a>
          <a title="Most of my open-soruce projects" itemprop="sameAs" href="http://github.com/tpetricek"><i class="fa fa-github-alt"></i></a>
          <a title="My F# answers on StackOverflow" itemprop="sameAs" href="http://stackoverflow.com/users/33518/tomas-petricek"><i class="fa fa-stack-overflow"></i></a>
          <a title="Read my papers!" itemprop="sameAs" href="http://dblp.uni-trier.de/pers/hd/p/Petricek:Tomas"><i class="fa fa-university"></i></a>
          <a title="Send me recruiter spam?" itemprop="sameAs" href="https://www.linkedin.com/in/tomaspetricek"><i class="fa fa-linkedin-square"></i></a>
        </p>
      </div>
    </div>
  </header></div>
  
  <div class="nav-wrapper hidden-xs-home">
  <nav>
    <div class="container"><div class="col-sm-12">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand visible-xs hidden-home toggle-tomas" href="/">Tomas Petricek <i class="tomas-fa fa fa-caret-up"></i></a>
      </div>
      <div id="navbar" class="navbar-collapse collapse">
        <ul class="nav navbar-nav navbar-right hidden-xs hidden-home">
          <li><a class="toggle-tomas" href="/">Tomas Petricek <i class="tomas-fa fa fa-caret-up"></i></a></li>
        </ul>
        <ul class="nav navbar-nav navbar-left">
          <li><a href="/">Home</a></li>
          <li><a href="http://fsharpworks.com"><span class="hidden-sm">F#</span> Trainings</a></li>
          <li><a href="http://fsharpworks.com/materials.html">Talks<span class="hidden-sm"> and books</span></a></li>
          <li><a href="http://thegamma.net/">The Gamma</a></li>
          <li><a href="/academic/" class="last-left">Academic</a></li>
        </ul>
      </div>
    </div></div>
  </nav></div>
  </div></div>
  
  
  <article class="post">
    <div class="container"><div class="row">
      <div class="col-lg-2 col-md-1"></div>
      <div class="col-xs-12 col-sm-12 col-md-10 col-lg-8">
        <h1>Beyond the Monad fashion (II.): Creating web forms with LINQ</h1>
<img src="http://tomasp.net/articles/formlets-in-linq/screen.png" style="margin:15px;float:right;" />
<p>The LINQ query syntax can be used for various things. Aside from writing queries, you can 
  also use it to encode any <em>monads</em>. This has become a fashionable topic, so you can learn
  more about it at many .NET conferences (for example <a href="http://gotocon.com/cph-2011/tracks/show_track.jsp?trackOID=434">GOTO 2011</a>).
  There are also many blog posts on this topic and I explained it in details in Chapter 12 of <a href="http://manning.com/petricek">my book</a> [<a href="#csformletsl">1</a>], which
  is available as a <a href="http://manning.com/petricek/SampleChapter12.pdf">free sample chapter</a> (PDF).</p>

<p>However, you can also use LINQ syntax for writing different types of computations. In a 
  <a href="http://tomasp.net/blog/idioms-in-linq.aspx">previous blog post</a>, I introduced <em>idioms</em>
  (also called <em>applicative functors</em>) and I demonstrated how to use the <code>join</code> syntax in LINQ
  to write computations based on idioms. We looked at a slightly boring, but simple example - zipping of lists - and
  we also implemented matrix transposition.</p>
 
<p>In this blog post, we look at a more exciting example. I explain <em>formlets</em>, which is an <em>idiom</em>
  for building web forms. Formlets give us an elegant functional way to create reusable components that encapsulate
  both visual aspect (HTML) and behavior (processing of requests). You can think of them as functional ASP.NET controls.
  Formlets come from the <a href="http://groups.inf.ed.ac.uk/links/formlets/">Links project</a> [<a href="#csformletsl">2</a>] and they are now used in commercial products like
  <a href="http://www.websharper.com/tutorials/GettingStartedWithFormlets.aspx">WebSharper</a> [<a href="#csformletsl">3</a>]. In this article, you'll see that we can (mis)use LINQ to get a nicer syntax
  for writing code using formlets. My C# implementation of formlets is based on a nice <a href="http://bugsquash.blogspot.com/2011/01/simple-implementation-of-formlets-in-f.html">F# formlets by Mauricio
  Scheffer</a> [<a href="#csformletsl">4</a>].</p>

<h2>The idea of formlets</h2>

<p>The key of formlets is simple. A formlet is some object of type <code>Formlet&lt;T&gt;</code> that represents
  a part of a HTML form that is used for entering values of type <code>T</code>. For example, a simple HTML <code>&lt;input /&gt;</code>
  will be represented as <code>Formlet&lt;string&gt;</code>. A more sophisticated component for selecting a date will be 
  represented as <code>Formlet&lt;DateTime&gt;</code>.</p>

<p>Now, what does it mean to represent a part of an HTML form? As already mentioned, there are two aspects of 
  a HTML form that we'd like to encapsulate in a formlet:</p>
<ul>
  <li style="margin-bottom:5px"><strong>Visual</strong> - A formlet needs to know how to render HTML markup of the form.
    It needs to generate <code>id</code> of form elements in some clever way so that we can use one formlet multiple
    times in a single form.</li>
  <li><strong>Behavior</strong> - When a response is received from a client, the formlet (<code>Formlet&lt;T&gt;</code>)
    needs to be able to produce a value of type <code>T</code> when we give it a name-value collection
    with form values received from the client.</li>
</ul>

<h3>Abstract formlet type</h3>
<img src="http://tomasp.net/articles/formlets-in-linq/formlet.png" style="float:right;margin:0px 5px 15px 15px" />
<p>Let's look how to model the two aspects using a simple F# type and we'll look at actual C# implementation later.
  To get some intuition about formlets, you can take a look at the diagram on the right.
  The two aspects of formlets can be modeled as two separate functions. For simplicity, we group them in a record:</p>
<pre lang="fsharp" style="margin-right:170px">
type Formlet&lt;'T&gt; = 
  { // Takes counter and generates XML together with new counter
    Render   : int -&gt; XElement * int
    // Takes counter and form values and generates result with new counter
    Evaluate : int * NameValueCollection -&gt; 'T * int }
</pre>
<p>The first function is used to render the formlet. When the page is loaded for the first time, we don't
  have any form values, so the rendering phase shouldn't rely on any inputs. The function just needs to produce
  some HTML output (stored as <code>XElement</code>). To be able to compose formlets,
  we pass around an <code>int</code> value that is used to generate unique <code>id</code> attributes. </p>
<p>The second function represents is used to process the next request from the client. When the
  user submits a form, we get <code>NameValueCollection</code> storing the form values. The <code>Evaluate</code>
  function turns the collection into a value of type <code>'T</code> (e.g. <code>string</code> or <code>DateTime</code>).
  We need to know the generated <code>id</code> to pick values from the collection, so we pass around an
  <code>int</code> counter in the same way as during rendering.</p>

<h3>Why are formlets interesting?</h3>
<p>The key thing that makes formlets interesting is that they are not <em>monads</em>. The operation
  that determines this is composition. A typical scenario is that we have some basic formlets (e.g.
  <code>Formlet.Input(label)</code> that generates <code>&lt;input&gt;</code> with a specified label)
  and we want to compose them. When composing formlets, the second formlet must not depend on the value
  produced by the first formlet. Using nested <code>from</code> clauses in LINQ (or using monads), we could write:</p>
<pre lang="csharp">
Formlet&lt;DateTime&gt; dateFormlet = 
  from day in Formlet.Input("Enter day:")
  from month in Formlet.Input("Enter month (selected day is {0}):", day)
  select new DateTime(day, month, 2011); 
</pre>
<p>The tricky thing in the snippet above is that we're using the variable <code>day</code> (representing
  value obtained from the first input) when creating the second input. If you think about it,
  this cannot possibly work, because there is no way the <code>Render</code> method could work.
  When rendering the form, we don't have form values, so we cannot assign any value to the 
  <code>day</code> variable.</p>
<p>This demonstrates an important property of monads - when composing two monads, we can use the
  value generated by the first one when creating the second one. This is also how <code>from</code>
  clause behaves in LINQ and why it doesn't work in our example.</p>
<p>On the other hand, when composing formlets we can only use the values produced by formlets 
  after we specify all the formlets that we want to compose. This code will not be executed during
  rendering (rendering will just render all formlets), but it will be used when processing
  the second request. Interestingly, it is still possible to write formlets using LINQ...</p>

<h2>Creating booking form with formlets</h2>
<p>In this section, we look at an example that uses formlets to create a simple booking form consisting
  of input for entering name and two controls for entering date (using drop-down boxes for selecting date,
  month and a year). We start by looking how to write this using LINQ and then we'll gradually explain how
  the solution works under the cover.</p>

<h3>Writing formlets using LINQ</h3>
<p>As I explained in a <a href="http://tomasp.net/blog/idioms-in-linq.aspx">previous blog post</a>,
  we can encode idioms (such as formlets) using the LINQ syntax. We've seen that we cannot use <code>from</code>
  clause (as when encoding monads), but we can do that using the <code>join</code> clause (and providing
  some dummy key selectors such as <code>on 1 equals 1</code>).</p>

<p>The following example uses this trick to create a formlet. We use a simple library with formlets for 
  basic HTML elements. The <code>Formlet.DropDownRange</code> method creates formlet that represents 
  drop-down containing numbers specified by the range (HTML <code>&lt;select&gt;</code>) and <code>Formlet.DropDown</code>
  fills the drop-down using a specified collection of key-value pairs; <code>Formlet.Tag</code> creates a simple HTML tag 
  and <code>Formlet.Input</code> creates a HTML text-box.</p>

<p>The following LINQ snippet creates the form shown on the screenshot at the beginning of the article:</p>

<pre lang="csharp">
Formlet&lt;DateTime&gt; dateSelector =
  from day in Formlet.DropDownRange(1, 31)
  join month in Formlet.DropDown(monthNames) on 1 equals 1
  let monthNum = Int32.Parse(month)
  join year in Formlet.DropDownRange(1960, 50) on 1 equals 1
  select new DateTime(year, monthNum, day);

Formlet&lt;Booking&gt; formlet =
  from name in Formlet.Input()
  join o1 in Formlet.Tag("br") on 1 equals 1
  join departureDate in dateSelector on 1 equals 1
  join o2 in Formlet.Tag("br") on 1 equals 1
  join returnDate in dateSelector on 1 equals 1
  select new Booking { Name = name, Departure = departureDate, Return = returnDate };
</pre>

<p>The first expression creates a formlet that can be used for entering dates. It renders three drop-down
  controls for entering day, month and a year. When writing the first one, we start the query with the 
  <code>from</code> clause. To add the other two, we use <code>join</code>. We also use <code>let</code> 
  inside the query to parse the string obtained from a drop-down. This is fine, but the LINQ syntax doesn't
  allow us to use the <code>monthNum</code> variable inside the next <code>join</code>. The <code>let</code>
  declaration is only useful to keep logically related things nearby, but it is always possible to 
  move all calculations to the last <code>select</code> clause.</p>

<p>The second expression creates a formlet for entering the whole booking. It starts with an usual input 
  element and then it re-uses the formlet for generating date selector two times. The types of 
  <code>departureDate</code> and <code>returnDate</code> are both <code>DateTime</code>, so this gives
  us a nice way of composing forms in a statically type-safe way. We also use a couple of <code>Tag</code>
  formlets to add line breaks (we still have to assign the result to some variable, but we can then 
  ignore them).</p>

<p>I hope you'll agree that the syntax is quite neat. You can get a complete sample (integrated in an
  ASP.NET MVC application) at the end of the article. Before writing a few things about the ASP.NET MVC 
  integration, let's look how the same formlet could be created using idiom primitives.</p>

<h3>Writing formlets explicitly</h3>
<p>As discussed in the previous blog post, every idiom needs to provide three primitive operations: 
  <code>Return</code>, <code>Merge</code> and <code>Select</code>. We can rewrite the previous example
  using the two latter ones. The <code>Merge</code> operation is used to combine two idioms (e.g. formlets) 
  into a single one that produces tuple containing values produced by both. <code>Select</code> gives
  us a way to apply some calculation to transform the carried value:</p>

<pre lang="csharp">
Formlet&lt;DateTime&gt; dateSelector =
  Formlet.DropDownRange(1, 31).Merge
    (Formlet.DropDown(monthNames).Select(Int32.Parse)).Merge
    (Formlet.DropDownRange(1960, 50)).Select(tup =>
  new DateTime(tup.Item1.Item1, tup.Item1.Item2, tup.Item2));
</pre>

<p>The snippet composes three formlets using <code>Merge</code>. The first and the third formlets are
  simply generated using <code>DropDownRange</code>. The second one generates a drop-down for selecting
  months and we transform it using <code>Select</code> to get a formlet that produces the number of 
  month as an <code>int</code> (corresponding to <code>let</code> in earlier LINQ query). The type of 
  the composed formlet is <code>Formlet&lt;Tuple&lt;int, Tuple&lt;int, int&gt;&gt;</code> and we use
  <code>Select</code> to turn the (ugly) nested tuple into a (nice) <code>DateTime</code> value.</p>

<h3>ASP.NET MVC Integration</h3>
<p>To make the article complete, I'll just briefly demonstrates how can formlets be integrated
  into an ASP.NET MVC application. After we declare a formlet (either in a separate file or as part
  of a controller class), we can use it in two view pages. In a first page, we want to render the
  formlet. To do this, we can simply assign the formlet to the <code>Model</code> property of the
  page. The ASP.NET markup for rendering the formlet looks like this:
</p>
<pre lang="aspx">
&lt;%@@ Page Language="C#" Inherits="ViewPage&lt;Formlet&lt;Booking&gt;&gt;" %&gt;

&lt;!-- Standard HTML markup --&gt;  
&lt;% using (Html.BeginForm("Booking", "Home")) { %&gt;
  &lt;%= Model.Render() %&gt;
  &lt;input type="submit" value="Submit" /&gt;
&lt;% } %&gt;
</pre>

<p>In the <code>@@ Page</code> directive, we specify that the model of the page is a formlet,
  so that we can access it via the <code>Model</code> property in a typed way. The page can
  contain any standard HTML markup. To include our form in the page, we create an HTML form
  (in a standard way) and then call <code>Model.Render()</code> to render the formlet. The method
  returns <code>XDocument</code> which will be printed to the output. (Earlier, we said that the
  method also takes an integer, but we can create an overload that calls the full version with
  0 as an argument).</p>

<p>When the form is submitted to a separate page (as specified by the 
  HTML form), we want to obtain the <code>Booking</code> object from the formlet. The values
  of generated HTML elements are stored in <code>Request.Form</code> (which is a 
  <code>NameValueCollection</code>). We can call <code>Evaluate</code> method of the formlet
  as follows:</p>
<pre lang="csharp">
Booking res = formlet.Evaluate(Request.Form);
ViewData.Model = res;
</pre>

<p>In the C# code of the page, we can use the <code>Evaluate</code> method. Just like in the
  previous snippet, we're using a slightly simplified version of the method. This overload takes
  just a <code>NameValueCollection</code> with the form values and gives us a result of type
  <code>Booking</code> (because our formlet has a type <code>Formlet&lt;Booking&gt;</code>).</p>

<p>The purpose of this short section was just to demonstrate that you can use formlets like 
  this as part of a real application. As already mentioned, you can find source code for this 
  sample at the end of the article. Now that you've seen an example of working with formlets,
  let's look how C# formlets are implemented...</p>

<h2>Looking under the cover</h2>
<p>As already mentioned, the implementation I'm using is based on an <a href="http://bugsquash.blogspot.com/2011/01/simple-implementation-of-formlets-in-f.html">F# 
  formlets by Mauricio Scheffer</a> [<a href="#csformletsl">4</a>]. His implementation uses
  slightly different definition of idioms, but the idea is the same. In the next section, we start
  by looking at the actual definition of <code>Formlet&lt;T&gt;</code> type.
</p>

<h3>Defining the Formlet type</h3>
<p>When introducing formlets earlier, I wrote that formlets can be viewed as two functions
  (one for rendering and one for evaluation). We needed to pass around <code>int</code> value 
  as a counter in both of the functions. The actual implementation uses a slightly different
  representation. Here, a formlet contains just a single function that takes <code>int</code>
  and produces <code>FormletResult&lt;T&gt;</code>. The result consists of a rendered XML
  and a function that can be used (when evaluating) to turn form inputs into a value
  (I'm using <code>Environment</code> as an alias for <code>NameValueCollection</code>):</p>
<pre lang="csharp">
class FormletResult&lt;T&gt; {
  // Rendered form stored as a list of XML elements
  public IEnumerable&lt;XNode&gt; Elements { get; set; }
  // Function (created by formlet) for processing form inputs
  public Func&lt;Environment, T&gt; Collector { get; set; }
  // Counter value after processing the formlet
  public int Counter { get; set; }
}

class Formlet&lt;T&gt; {
  // Function that runs the formlet when given an 'int' value
  public Func&lt;int, FormletResult&lt;T&gt;&gt; Func { get; set; }
  
  // Phase 1: Use formlet to create HTML of a form  
  public XDocument Render() {
    return new XDocument(new XElement("div", Func(0).Elements));
  }
  // Phase 2: Use formlet to process form inputs
  public T Evaluate(Environment env) {
    return Func(0).Collector(env);
  }
}
</pre>

<p>The type declarations are fairly simple. The <code>FormletResult&lt;T&gt;</code>
  type simply stores rendered elements, function for evaluation and a new counter. 
  For simplicity, I'm using mutable properties, but we'll use the type in an immutable
  fashion (we will use setter only when creating the object).</p>

<p>The <code>Formlet&lt;T&gt;</code> type is also quite simple. It contains a function that
  can be called with initial counter as an argument and produces <code>FormletResult&lt;T&gt;</code>.
  The function is called when we want to render the formlet as well as when we want to 
  process form inputs. In the first case (the <code>Render</code> method), we simply call 
  the function and wrap all generated XML elements inside a single <code>&lt;div&gt;</code> element.
  In the second case (<code>Evaluate</code>), we first run the function and then use the
  constructed function (named <code>Collector</code>) to actually process the inputs. Note
  again that we don't need the form inputs to render the formlet!
  </p>

<p>In the implementation, we also declare a static method <code>Formlet.Create</code> (in a
  static non-generic class), so that we can create formlets and benefit from the C# type
  inference for generic method calls. The next section gives some examples...</p>

<h3>Building primitive formlets</h3>
<p>When creating complex formlets such as the date selection or the booking form above, we
  can use LINQ query syntax and compose them from simpler formlets. However, elementary formlets
  such as <code>Formlet.Input()</code> need to be created explicitly. This is also a good way to 
  understand how formlets work:</p>

<pre lang="csharp">
public static Formlet&lt;string&gt; Input() {
  return Formlet.Create(counter =&gt; new FormletResult&lt;string&gt; {
    Elements = new List&lt;XElement&gt; {
      new XElement("input", new XAttribute("name", "frmel" + counter))
    },
    Counter = counter + 1
    Collector = env =&gt; env["frmel" + counter],
  });
}
</pre>
<p>To create a formlet for input, we need to write a function that constructs 
  <code>FormletResult&lt;string&gt;</code> when given an integer (counter). In this simple
  example, we set <code>Elements</code> to a list containing a single <code>&lt;input&gt;</code>
  element. The <code>id</code> attribute of the element is set to some generated name that
  includes the current value of <code>counter</code>. The <code>Counter</code> property is set
  to the successor of <code>counter</code>, because we used a single ID. This way, we can 
  compose two <code>Input</code> formlets and they will use different <code>id</code>.
</p>
<p>Finally, we also need to construct the <code>Collector</code> function. This is quite simple.
  When given an environment (a <code>NameValueCollection</code> value), the function performs
  a lookup using the same <code>id</code> that it used during rendering. The value from the 
  collection is a string, so it can be returned as a result.</p>

<h3>Implementing idiom operations</h3>
<p>As mentioned earlier, formlets are <em>idioms</em>, which is a type of computation that
  I introduced in the <a href="http://tomasp.net/blog/idioms-in-linq.aspx">previous blog post</a>. 
  Every idiom needs to provide three operations: <code>Merge</code>, <code>Select</code> and 
  <code>Return</code> (using these operations, we can also implement <code>Join</code> extension
  method that is used by LINQ when translating the <code>join</code> clause). The types of the 
  three methods that we need to implement for formlets are explained in the previous article.
  Once we have the types, writing the actual implementation is quite easy (I omitted the
  <code>Return</code> operation, because it isn't particularly useful for formlets):</p>

<pre lang="csharp">
// Create formlet that composes two formlets. The formlets are rendered
// in in sequence and their values are merged into a tuple.
public static Formlet&lt;Tuple&lt;T1, T2&gt;&gt; Merge&lt;T1, T2&gt;
    (this Formlet&lt;T1&gt; first, Formlet&lt;T2&gt; second) {
  return Formlet.Create(i =&gt; {
    var v1 = first.Func(i);
    var v2 = second.Func(v1.Counter);
    return new FormletResult&lt;Tuple&lt;T1, T2&gt;&gt; {
      Elements = Enumerable.Concat(v1.Elements, v2.Elements),
      Collector = env =&gt; 
        Tuple.Create(v1.Collector(env), v2.Collector(env)),
      Counter = v2.Counter
    };
  });
}

// Create formlet that transforms value created by the original formlet;
// rendering just returns elements of the original formlet.
public static Formlet&lt;R&gt; Select&lt;T, R&gt;
    (this Formlet&lt;T&gt; source, Func&lt;T, R&gt; func) {
  return Formlet.Create(i =&gt; {
    var value = source.Func(i);
    return new FormletResult&lt;R&gt; {
      Elements = value.Elements,
      Collector = env =&gt; func(value.Collector(env)),
      Counter = value.Counter
    };
  });
}
</pre>
<p>When combining two formlets using <code>Merge</code>, we run the functions
  that define them in sequence. We pass initial counter to the first formlet and then
  pass the returned (incremented) counter to the second formlet. To build the result,
  we simply concatenate all generated XML elements. The <code>Collector</code> function
  runs <code>Collector</code> function of both original formlets and returns a tuple
  carrying both values together.</p>

<p>The <code>Select</code> operation builds formlet that behaves similarly to the 
  original formlet. The only difference is that the <code>Collector</code> function
  transforms the value using a provided function. This is how we turn the tuple values created
  by <code>Merge</code> into the final result of a formlet (such as <code>DateTime</code>).</p>

<p>Now that we have the idiom operations, it is very easy to support the LINQ syntax
  using the <code>join</code> clause. We just need to implement the <code>Join</code>
  method in terms of <code>Merge</code> and <code>Select</code>. This implementation 
  is exactly the same for all idioms, so you can find it in the 
  <a href="http://tomasp.net/blog/idioms-in-linq.aspx">previous article</a>.</p>

<h2>Summary</h2>
<p>In this article we looked how to use the concept of formlets in C# using the LINQ
  query syntax. Formlets is a nice functional abstraction for HTML forms. They 
  encapsulate two aspects of HTML forms - request processing and form rendering - in 
  a single composable type.</p>
<p>Formlets are interesting because they are <em>idioms</em>. This is an abstract type
  of computations  (just like pupular <em>monads</em>). Interestingly, formlets cannot 
  be treated as monads, because we cannot use value produced by formlet as argument to 
  a second formlet in composition. This may be a bit confusing, but when you'll try to 
  implement <code>SelectMany</code> for formlets, you'll see the problem.</p>

<p>The fact that the structure of formlet cannot depend on the values is an essential aspect 
  of idioms. However, even though formlets are not monads, we can use a nice LINQ query
  syntax to write them. In a sense this controverts the general sense that LINQ is a monad.
  The trick is that we build our syntax on the <code>join</code> clause which is handled
  using different rules than nested <code>from</code> clauses (usually used for monads).</p>

<a name="csformletsl"></a>
<h2>References &amp; Downloads</h2>
<ul>
  <li>Browse the <a href="https://github.com/tpetricek/Documents/tree/master/Blog%202011/Formlets%20using%20LINQ">source on GitHub</a> or download sample project as a <a href="https://github.com/tpetricek/Documents/raw/master/Blog%202011/Formlets%20using%20LINQ/formlets.zip">ZIP file</a>.</li>
</ul>
<ul>
  <li>[1] <a href="http://manning.com/petricek/SampleChapter12.pdf" type="external">Chapter 12: Sequence expressions and alternative workflows</a> - Real-World Functional Programming</li>
  <li>[2] <a href="http://groups.inf.ed.ac.uk/links/formlets/" type="external">The essence of form abstraction</a> - Ezra Cooper, Sam Lindley, Philip Wadler, Jeremy Yallop</li>
  <li>[3] <a href="http://www.websharper.com/tutorials/GettingStartedWithFormlets.aspx">Getting started with formlets</a> - WebSharper</li>
  <li>[4] <a href="http://bugsquash.blogspot.com/2011/01/simple-implementation-of-formlets-in-f.html">A simple implementation of formlets in F#</a> - Bug Squash by Mauricio Scheffer</li>
</ul>

        <div class="info">
        <p class="share">
            <a target="_blank" href="https://twitter.com/intent/tweet?url=http%3a%2f%2ftomasp.net%2fblog%2fformlets-in-linq.aspx%2f&amp;text=Beyond+the+Monad+fashion+(II.)%3a+Creating+web+forms+with+LINQvia+%40tomaspetricek">
              <i class="fa fa-twitter-square"></i></a>
            <a target="_blank" href="https://www.facebook.com/sharer.php?u=http%3a%2f%2ftomasp.net%2fblog%2fformlets-in-linq.aspx%2f">
              <i class="fa fa-facebook-official"></i></a>
            <a href="http://www.reddit.com/submit?url=http%3a%2f%2ftomasp.net%2fblog%2fformlets-in-linq.aspx%2f&title=Beyond+the+Monad+fashion+(II.)%3a+Creating+web+forms+with+LINQ">
              <i class="fa fa-reddit-square"></i></a>
            <a href="mailto:?subject=Beyond%20the%20Monad%20fashion%20(II.)%3a%20Creating%20web%20forms%20with%20LINQ&body=%20Formlets%20are%20elegant%20functional%20abstraction%20for%20describing%20web%20forms%20encapsulating%20both%20rendering%20and%20functionality.%20In%20this%20article%2c%20we%20look%20how%20to%20write%20formlets%20in%20C%23.%20Although%20formlets%20are%20not%20monads%2c%20we%20can%20still%20use%20elegant%20LINQ%20syntax.%20Interestingly%2c%20using%20the%20join%20clause...%0a%0aSee%3a%20http%3a%2f%2ftomasp.net%2fblog%2fformlets-in-linq.aspx%2f">
              <i class="fa fa-envelope"></i></a>
        </p>
        <p class="details">
          <strong>Published:</strong> Monday, 14 March 2011, 5:14 PM<br />
          <strong>Author:</strong> Tomas Petricek<br />
          <strong>Typos:</strong> <a href="http://github.com/tpetricek/tomasp.net">Send me pull request</a>!<br />
          <strong>Tags:</strong> <a
          href="/blog/tag/csharp/">c#</a>, <a
          href="/blog/tag/research/">research</a></span><br />
        </p>
        </div>
      </div>
    </div></div>
  </article>

  
  </div>
  <footer>
  <div class="container"><div class="row">
    <div class="col-sm-3">
      <h4>Contact &amp; about</h4>
      <p>This site is hosted on GitHub and is generated using <a href="https://github.com/tpetricek/FSharp.Formatting">F# Formatting</a>
        and <a href="http://dotliquidmarkup.org/">DotLiquid</a>.
        For more info, see the <a href="https://github.com/tpetricek/tomasp.net">website source on GitHub</a>.
      </p>
      <p>Please submit issues &amp; corrections on GitHub. Use pull requests for minor corrections only.</p>
      <ul>
        <li><i class="fa fa-twitter"></i> Twitter: <a href="http://twitter.com/tomaspetricek">@tomaspetricek</a></li>
        <li><i class="fa fa-github"></i> GitHub: <a href="https://github.com/tpetricek">@tpetricek</a></li>
        <li><i class="fa fa-envelope"></i> Email me: <a href="mailto:tomas@tomasp.net">tomas@tomasp.net</a></li>
      </ul>
    </div>
    <div class="col-sm-7">
    <h4><a href="http://tomasp.net/rss.xml"><i class="fa fa-rss" style="margin-right:5px;"></i></a> Blog archives</h4>
      
      <a href="/blog/archive/august_2016/">August 2016 (1)</a>,&nbsp;
      
      <a href="/blog/archive/july_2016/">July 2016 (1)</a>,&nbsp;
      
      <a href="/blog/archive/may_2016/">May 2016 (2)</a>,&nbsp;
      
      <a href="/blog/archive/april_2016/">April 2016 (1)</a>,&nbsp;
      
      <a href="/blog/archive/december_2015/">December 2015 (2)</a>,&nbsp;
      
      <a href="/blog/archive/november_2015/">November 2015 (1)</a>,&nbsp;
      
      <a href="/blog/archive/september_2015/">September 2015 (3)</a>,&nbsp;
      
      <a href="/blog/archive/july_2015/">July 2015 (1)</a>,&nbsp;
      
      <a href="/blog/archive/june_2015/">June 2015 (1)</a>,&nbsp;
      
      <a href="/blog/archive/may_2015/">May 2015 (2)</a>,&nbsp;
      
      <a href="/blog/archive/april_2015/">April 2015 (3)</a>,&nbsp;
      
      <a href="/blog/archive/march_2015/">March 2015 (2)</a>,&nbsp;
      
      <a href="/blog/archive/february_2015/">February 2015 (1)</a>,&nbsp;
      
      <a href="/blog/archive/january_2015/">January 2015 (2)</a>,&nbsp;
      
      <a href="/blog/archive/december_2014/">December 2014 (1)</a>,&nbsp;
      
      <a href="/blog/archive/may_2014/">May 2014 (3)</a>,&nbsp;
      
      <a href="/blog/archive/april_2014/">April 2014 (2)</a>,&nbsp;
      
      <a href="/blog/archive/march_2014/">March 2014 (1)</a>,&nbsp;
      
      <a href="/blog/archive/january_2014/">January 2014 (2)</a>,&nbsp;
      
      <a href="/blog/archive/december_2013/">December 2013 (1)</a>,&nbsp;
      
      <a href="/blog/archive/november_2013/">November 2013 (1)</a>,&nbsp;
      
      <a href="/blog/archive/october_2013/">October 2013 (1)</a>,&nbsp;
      
      <a href="/blog/archive/september_2013/">September 2013 (1)</a>,&nbsp;
      
      <a href="/blog/archive/august_2013/">August 2013 (2)</a>,&nbsp;
      
      <a href="/blog/archive/may_2013/">May 2013 (1)</a>,&nbsp;
      
      <a href="/blog/archive/april_2013/">April 2013 (1)</a>,&nbsp;
      
      <a href="/blog/archive/march_2013/">March 2013 (1)</a>,&nbsp;
      
      <a href="/blog/archive/february_2013/">February 2013 (1)</a>,&nbsp;
      
      <a href="/blog/archive/january_2013/">January 2013 (1)</a>,&nbsp;
      
      <a href="/blog/archive/december_2012/">December 2012 (2)</a>,&nbsp;
      
      <a href="/blog/archive/october_2012/">October 2012 (1)</a>,&nbsp;
      
      <a href="/blog/archive/august_2012/">August 2012 (3)</a>,&nbsp;
      
      <a href="/blog/archive/june_2012/">June 2012 (2)</a>,&nbsp;
      
      <a href="/blog/archive/april_2012/">April 2012 (1)</a>,&nbsp;
      
      <a href="/blog/archive/march_2012/">March 2012 (4)</a>,&nbsp;
      
      <a href="/blog/archive/february_2012/">February 2012 (5)</a>,&nbsp;
      
      <a href="/blog/archive/january_2012/">January 2012 (2)</a>,&nbsp;
      
      <a href="/blog/archive/november_2011/">November 2011 (5)</a>,&nbsp;
      
      <a href="/blog/archive/august_2011/">August 2011 (3)</a>,&nbsp;
      
      <a href="/blog/archive/july_2011/">July 2011 (2)</a>,&nbsp;
      
      <a href="/blog/archive/june_2011/">June 2011 (2)</a>,&nbsp;
      
      <a href="/blog/archive/may_2011/">May 2011 (2)</a>,&nbsp;
      
      <a href="/blog/archive/march_2011/">March 2011 (4)</a>,&nbsp;
      
      <a href="/blog/archive/december_2010/">December 2010 (1)</a>,&nbsp;
      
      <a href="/blog/archive/november_2010/">November 2010 (6)</a>,&nbsp;
      
      <a href="/blog/archive/october_2010/">October 2010 (6)</a>,&nbsp;
      
      <a href="/blog/archive/september_2010/">September 2010 (4)</a>,&nbsp;
      
      <a href="/blog/archive/july_2010/">July 2010 (3)</a>,&nbsp;
      
      <a href="/blog/archive/june_2010/">June 2010 (2)</a>,&nbsp;
      
      <a href="/blog/archive/may_2010/">May 2010 (1)</a>,&nbsp;
      
      <a href="/blog/archive/february_2010/">February 2010 (2)</a>,&nbsp;
      
      <a href="/blog/archive/january_2010/">January 2010 (3)</a>,&nbsp;
      
      <a href="/blog/archive/december_2009/">December 2009 (3)</a>,&nbsp;
      
      <a href="/blog/archive/july_2009/">July 2009 (1)</a>,&nbsp;
      
      <a href="/blog/archive/june_2009/">June 2009 (3)</a>,&nbsp;
      
      <a href="/blog/archive/may_2009/">May 2009 (2)</a>,&nbsp;
      
      <a href="/blog/archive/april_2009/">April 2009 (1)</a>,&nbsp;
      
      <a href="/blog/archive/march_2009/">March 2009 (2)</a>,&nbsp;
      
      <a href="/blog/archive/february_2009/">February 2009 (1)</a>,&nbsp;
      
      <a href="/blog/archive/december_2008/">December 2008 (1)</a>,&nbsp;
      
      <a href="/blog/archive/november_2008/">November 2008 (5)</a>,&nbsp;
      
      <a href="/blog/archive/october_2008/">October 2008 (1)</a>,&nbsp;
      
      <a href="/blog/archive/september_2008/">September 2008 (1)</a>,&nbsp;
      
      <a href="/blog/archive/june_2008/">June 2008 (1)</a>,&nbsp;
      
      <a href="/blog/archive/march_2008/">March 2008 (3)</a>,&nbsp;
      
      <a href="/blog/archive/february_2008/">February 2008 (1)</a>,&nbsp;
      
      <a href="/blog/archive/december_2007/">December 2007 (2)</a>,&nbsp;
      
      <a href="/blog/archive/november_2007/">November 2007 (6)</a>,&nbsp;
      
      <a href="/blog/archive/october_2007/">October 2007 (1)</a>,&nbsp;
      
      <a href="/blog/archive/september_2007/">September 2007 (1)</a>,&nbsp;
      
      <a href="/blog/archive/august_2007/">August 2007 (1)</a>,&nbsp;
      
      <a href="/blog/archive/july_2007/">July 2007 (2)</a>,&nbsp;
      
      <a href="/blog/archive/april_2007/">April 2007 (2)</a>,&nbsp;
      
      <a href="/blog/archive/march_2007/">March 2007 (2)</a>,&nbsp;
      
      <a href="/blog/archive/february_2007/">February 2007 (3)</a>,&nbsp;
      
      <a href="/blog/archive/january_2007/">January 2007 (2)</a>,&nbsp;
      
      <a href="/blog/archive/november_2006/">November 2006 (1)</a>,&nbsp;
      
      <a href="/blog/archive/october_2006/">October 2006 (3)</a>,&nbsp;
      
      <a href="/blog/archive/august_2006/">August 2006 (2)</a>,&nbsp;
      
      <a href="/blog/archive/july_2006/">July 2006 (1)</a>,&nbsp;
      
      <a href="/blog/archive/june_2006/">June 2006 (3)</a>,&nbsp;
      
      <a href="/blog/archive/may_2006/">May 2006 (2)</a>,&nbsp;
      
      <a href="/blog/archive/april_2006/">April 2006 (2)</a>,&nbsp;
      
      <a href="/blog/archive/december_2005/">December 2005 (1)</a>,&nbsp;
      
      <a href="/blog/archive/july_2005/">July 2005 (4)</a>,&nbsp;
      
      <a href="/blog/archive/june_2005/">June 2005 (5)</a>,&nbsp;
      
      <a href="/blog/archive/may_2005/">May 2005 (1)</a>,&nbsp;
      
      <a href="/blog/archive/april_2005/">April 2005 (3)</a>,&nbsp;
      
      <a href="/blog/archive/march_2005/">March 2005 (3)</a>,&nbsp;
      
      <a href="/blog/archive/january_2005/">January 2005 (1)</a>,&nbsp;
      
      <a href="/blog/archive/december_2004/">December 2004 (3)</a>,&nbsp;
      
      <a href="/blog/archive/november_2004/">November 2004 (2)</a>,&nbsp;
      
    </div>
    <div class="col-sm-2">
      <h4>License</h4>
      <p>Unless explicitly mentioned, all articles on this site are licensed under <a href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution Share Alike</a>.
        All source code samples are licensed under Apache 2.0.
      </p>
      <p style="text-align:center;margin-top:15px;"><img src="http://tomasp.net/img/cc-sa.png" alt="CC License logo" /></p>
    </div>
  </div></div>
  </footer>

  <!-- Third-party standard references -->
  <script src="https://code.jquery.com/jquery-2.2.4.min.js"
    integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"
    integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  <script type="text/javascript" src="/custom/tooltips.js"></script>
    
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1561220-1']);
    _gaq.push(['_trackPageview']);
    (function () {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
  <script type="text/javascript">
    var small = (window.innerWidth * window.innerHeight) < 500000;
    if (!small) {
      if ($("body").attr("class").trim() == "home") $('nav').affix({ offset: { top: $('header').outerHeight() }}); 
      else $('.top-panel').addClass("fixed");
    }
    var opened = false;
    function hideOrShow() {
      opened = !opened;
      $("#tomas").show(); 
      $(".tomas-fa").toggleClass("fa-caret-up");
      $(".tomas-fa").toggleClass("fa-caret-down");
      $("#tomas").css("max-height", $("#tomas").css("max-height")!="800px"?"800px":"0px");
      return false; 
    }
    $('.toggle-tomas').on("click", hideOrShow);
    window.onscroll = function() { if (opened) {
      if (!small) hideOrShow(); 
    } };
  </script>
</body>
</html>
